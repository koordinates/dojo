<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
  <title>Browser Bugs</title>
<!--
  <script type="text/javascript">
    document.write('<script type="text/javascript" src="bb_script.js"><\/script>');
  </script>
-->
</head>
<body>
<center><h1>Browser Bugs</h1></center>

This table does not purport to list even all the bugs that we work around
in the library, let alone all the many CSS and DOM bugs that exist.
Rather this just lists a few browser bugs that are particularly egregious
or hard to work around cleanly, and so affect our ability to support
the browser with our library.
<p>
For some general discussion of available browsers, see <a href="../../build/doc/browsers.html">browsers.html</a> .
<p>
All of these tests pass on: Mozilla 1.4a, IE6, Opera 7.5. 
It is only the KHTML browser family that is still shipping product with such bugs.

<p>
Oh, and guess what? I can crash the entire Safari 1.2 browser (click to make it happen): 
<script type="text/javascript">
   // I'm sure this could be narrowed down even more.
   // I'm guessing it is probably a garbage collection issue.
   // Dangerous symbols seem to include: 'removeEventListener', 'history', 'onselect', 'name'
   var mywindow = window;
   function loopover(obj) {
     var a = [];
     if (!obj) obj = mywindow;
     for(var k in obj) {
       if (typeof obj[k] == 'function') a.push(k);
     }
     // alert('ok');
   }
   function crash_safari(obj) {
     loopover(obj);
     loopover(obj);
     alert("In Safari, you'd be dead now.");
   }
</script>
<div onclick="crash_safari()"><b><code>crash_safari()</code></b></div> 
View source for more information.

<p>
An "X" means it has the bug.

<table border="1">
<thead><tr>
   <th>Bug</th><th>Click to Test</th><th>IE5.0PC</th><th>IE5Mac</th><th>Saf 1.x</th><th>Konq 3.1.1</th><th>Op 7.10</th><th>ICE 5.4.1
</tr></thead>

<tbody>

<tr>
<td>no "instanceof" operator</td><td>
    <div onclick="if ({} instanceof Object) {} alert('ok')"><code>
                  if ({} instanceof Object) {} alert('ok')
    </code></div>
</td>
<td></td><td>X</td>
</tr>

<tr>
<td>no boolean "in" operator</td><td>
    <div onclick="if ('a' in window) {} alert('ok')"><code>
                  if ('a' in window) {} alert('ok')
    </code></div>
</td>
<td>X</td><td>X</td>
</tr>

<tr>
<td>problem parsing implied semi-colon</td><td>
    <div onclick="try{throw new Error('boo')} catch(e) {} alert('ok')"><code>
                  try{throw new Error('boo')} catch(e) {} alert('ok')
    </code></div>
</td>
<td></td><td></td><td>X</td><td>X</td>
</tr>

<!--
<tr>
<td>doesn't support Error as function</td><td>
    <div onclick="try{throw Error('boo');} catch(e) {} alert('ok')"><code>
                  try{throw Error('boo');} catch(e) {} alert('ok')
    </code></div>
</td>
<td></td><td></td><td></td><td>?</td>
</tr>
-->

<tr>
<td>problem parsing named functions</td>
<td>
    <div onclick="function noop(f) {}; noop(function foobar() {}); alert('ok')"><code>
                  function noop(f) {}; noop(function foobar() {}); alert('ok')
    </code></div>
</td>
<td></td><td></td><td>X</td><td>X</td>
</tr>

<!-- is this a real requirement in ECMAScript? moz fails too.
<tr>
<td>problem calling named functions</td>
<td>
    <div onclick="var NS = {}; NS.foo = function NS_foo() {}; if (NS_foo) alert('ok')"><code>
                  var NS = {}; NS.foo = function NS_foo() {}; if (NS_foo) alert('ok')
    </code></div>
</td>
<td>KHTML (Safari 60, Konqueror 3.0.4 and 3.1.1)</td>
</tr>
-->

<tr>
<td>missing Node.addEventListener and Node.attachEvent</td>
<td>
    <div onclick="if (document.body.addEventListener || document.body.attachEvent) alert('ok')"><code>
                  if (document.body.addEventListener || document.body.attachEvent) alert('ok')
    </code></div>
</td>
<td></td><td>X</td>
</tr>

<tr>
<td>can't load a script via createElement('script')<br>(all but Opera can do a document.write creation before onload)</td>
<td>
<!-- el.type = 'text/javascript' -->
   <script type="text/javascript">
      function create_script() {
      var el = document.createElement('script'); 
      el.src = 'bb_script.js'; 
      //el.onload = function() {alert('in script element onload via expando = Function')}; 
      //el.onload = "alert('in script element onload via expando = String')"; 
      el.setAttribute("onload", "alert('in script element onload via setAttribute String')"); 
      if (el.addEventListener) el.addEventListener('load', function() {alert('in script element onload via addEventListener')}, false); 
      if (el.attachEvent) el.attachEvent('onload', function() {alert('in script element onload via attachEvent')}); 
      document.body.appendChild(el);
      }
   </script>

   <div onclick="create_script()"><code>
      var el = document.createElement('script'); el.src = 'bb_script.js'; document.body.appendChild(el);
   </code></div>
</td>
<!-- OK: IE5, Moz. Moz does element onload, IE does not -->
<td></td><td>X</td><td>X</td><td>X</td><td>X (v7.5 ok)</td><td>X</td>
</tr>

<!--
   <script type="text/javascript">
      function write_script() {document.write('<script type="text/javascript" src="bb_script.js"><\/script>');}
   </script>
   <div onclick="write_script()">by document.write</div>

   <div id="script_test"></div>
   <script type="text/javascript">
     function inner_script() {document.getElementById('script_test').innerHTML = '<script type="text/javascript" src="bb_script.js"><\/script>'; alert('set div innerHTML');}   
     function inner_script2() {document.body.innerHTML += '<script type="text/javascript" src="bb_script.js"><\/script>'; alert('set innerHTML');}   
   </script>
   <div onclick="inner_script()">by div innerHTML</div>
   <div onclick="inner_script2()">by body innerHTML</div>
-->

<!--
<tr>
<td>can't load a script via innerHTML (not a requirement)</td>
<td>
<script type="text/javascript">
  function add_script() {
    var ih = document.body.innerHTML;
    document.body.innerHTML = ih + '<' + 'script type="text/javascript" src="bb_script.js" onload="alert(\'in script element onload\')"><' + '/script>';
  }
</script>
   <div onclick="add_script()"><code>
      document.body.innerHTML += "&lt;script type='text/javascript' src='bb_script.js'>&lt;/script>"
   </code></div>
</td>
<td><td>
</tr>
-->

<!--
<tr>
<td>setting style by expando</td>
<td>
   <div id="style_test">some text</div>
   <div onclick="document.getElementById('style_test').style.color = 'green'">
       document.getElementById('style_test').style.color = 'green';
   </div>
</tr>

<tr>
<td>setting style by setProperty</td>
<td>
   <div id="style_test2">some text</div>
   <div onclick="document.getElementById('style_test2').style.setProperty('color', 'green', '')">
       document.getElementById('style_test2').style.setProperty('color', 'green', '')
   </div>
</tr>
-->


<tr>
<td>missing encodeURIComponent and decodeURIComponent</td>
<td>
    <div onclick="encodeURIComponent('a'); decodeURIComponent('a'); alert('ok')"><code>
      encodeURIComponent('a'); decodeURIComponent('a'); alert('ok')
    </code></div>
</td>
<td>X</td><td>X</td><td>X (v1.2 ok)</td><td>X</td>
</tr>

<tr>
<td>missing Number.toFixed (and toPrecision, toExponential)</td>
<td>
    <div onclick="(.51).toFixed(0); alert('ok')"><code>
      (.51).toFixed(0); alert('ok')
    </code></div>
</td>
<td>X</td><td>X</td><td>X</td><td>X</td>
</tr>

<script type="text/javascript">
  function test_replace() {
     if (("aaa").replace(/(\w)/g, function() {return 'b'}) == 'bbb') alert('ok');
  }
</script>
<tr>
<td>no String.replace(RegExp, Function)</td>

<td>
    <div onclick="test_replace()"><code>
       if (("aaa").replace(/(\w)/g, function() {return 'b'}) == 'bbb') alert('ok');
    </code></div>
</td>
<td>X</td><td>X</td><td>X</td><td>X</td>
</tr>


<tr>
<td>setTimeout of a function</td>
<td>
<div onclick="setTimeout(function() {alert('ok')},0)"><code>
              setTimeout(function() {alert('ok')},0)
</code></div>
</td>
<td></td><td></td><td>X (v1.2 ok)</td><td>X</td>
</tr>

<!-- IE(IE5.0 Win and IE5.x Mac have no Array.push) -->
<tr>
<td>buggy Array.concat</td>
<td>
    <div onclick="if (1 == [].concat([['a']][0]).length) alert('ok')"><code>
                  if (1 == [].concat([['a']][0]).length) alert('ok')
    </code></div>
</td>
<td></td><td></td><td></td><td>ok (bug in Konqueror 3.0.4)</td>
</tr>


<!--
<tr>
<td>KHTML, Opera</td>
<td>[].constructor != Array</td>
<td>
no reliable standalone test, but some of our tests fail otherwise.
<p>
<script type="text/javascript">function test_array(arr) {if (arr.constructor === Array) alert('ok'); else if (arr.constructor == Array) alert('==Array, not ==='); else alert('arr.constructor=' + arr.constructor);}</script>
<iframe src="bb_frame_array.html"></iframe>
</td>
</tr>
-->

<tr>
<td>return out of some nested switch statements</td>
<td>
<script type="text/javascript">
function test_switch() {
  switch(1) {
  // with the curly brackets, it works.
  // without the curly brackets, the alert is run, but not the return
  case 1: //{
    switch('a') {
    case 'a': alert('case a'); return 'a';
    }
    return false;
    //}
  }
  return false;
}
</script>
<div onclick="if (test_switch()) alert('ok')"><code>
  /* view source to see test_switch() */
  if (test_switch()) alert('ok')
</code></div>
</td>
<td></td><td></td><td></td><td>ok (bug in Konqueror 3.0.x)</td>
</tr>
<!--<tr><td><td><td>KHTML<td>Safari 73 has fix</tr>-->

<!--
<tr>
<td></td>
<td>nested anonymous functions</td>
<td>
<div onclick="function callit(f) {f()} callit(function() {callit(function() {alert('ok')})})"><code>
              function callit(f) {f()} callit(function() {callit(function() {alert('ok')})})
</code></div>
</td>
</tr>
-->

<!--
<tr>
<td></td>
<td>parsing for loops</td>
<td>
<div onclick="for(var i=0,j=0; i<10; i++,j++) {if (i==9) alert('ok')}"><code>
              for(var i=0,j=0; i<10; i++,j++) {if (i==9) alert('ok')}
</code></div>
</td>
</tr>
-->
</tbody>
</table>

<h1>Dynamic script Support</h1>

The W3 standards say nothing about an "onload" handler for script elements (or img elements for that matter: just document, frames, and object).
In practice, using the test listed in the table above,
here is what we have found for dynamically created script elements:
<table border="1">
<tr><th>Browser<th>script itself<th>expando = Function<th>expando = String<th>setAttribute String<th>addEventListener<th>attachEvent
<tr><td>Mozilla 1.7b<td>Y<td><td>Y<td>Y<td>Y<td>
<tr><td>IE5.0 Win<td>Y<td><td><td><td>
<tr><td>Opera 7.5<td>Y<td><td><td><td>
<tr><td>Safari 1.2<td>(doesn't work at all)<td><td><td><td>
</table>

<h1>Dynamic iframe Support</h1>

<script type="text/javascript">
function get_frame_window(testid, frameid, made_how, prevlen) {
  if (window.frames[frameid]) {
     alert('passed ' + testid + ': found in window.frames by id when made via ' + made_how);
     return window.frames[frameid];
  }
  if (window.frames.length > prevlen) {
    alert('passed ' + testid + ': found in window.frames by index when made via ' + made_how);
    return window.frames[window.frames.length - 1];
  }
  alert('failed ' + testid + ': not found in window.frames by index or id when made via ' + made_how + 
    ',\nlength=' + window.frames.length + ' and was ' + prevlen);
  // the failure alert was an opportunity to do some creation
  if (window.frames[frameid]) {
     alert('passed ' + testid + ' on second attempt by id (after alert)');
     return window.frames[frameid];
  }
  if (window.frames.length > prevlen) {
    alert('passed ' + testid + ' on second attempt by index (after alert)');
    return window.frames[window.frames.length - 1];
  }
  return null;
}

function test_iframe() {
  // IE5.0 PC throws "Class doesn't support Automation" at window.frames['id'] if createElement used.
  var ua = navigator.userAgent.toLowerCase();
  // createElement no good on IE5.0 Win
  var bug_createElement = ua.indexOf("msie 5.0") != -1 && (typeof navigator.__ice_version == 'undefined');
  if (bug_createElement) alert("assuming createElement won't work, for userAgent=" + navigator.userAgent);

  // doing document.write to an iframe with src='' is security error in Opera 7.10
  // even with a close first.
  var bug_emptySrc = ua.indexOf('opera') != -1;

  var prevlen;

  // simple iframe with specified src, made with innerHTML
  //if (/*bug_createElement &&*/ typeof document.body.insertAdjacentHTML != 'undefined') {
  if (typeof document.body.innerHTML != 'undefined') {
    var ifh = '<iframe id="idh" name="idh" src="bb_iframe3.html" onload="alert(\'passed A iframe element onload when created with html\')"><\/iframe>';
    //document.body.insertAdjacentHTML('beforeEnd', ifh);
    prevlen = window.frames.length;
    document.body.innerHTML += ifh;
    var ifw = get_frame_window('C', 'idh', 'innerHTML', prevlen);
  }
  else alert("no innerHTML support (not standard)");

  // simple iframe with specified src, made with createElement

  if (!bug_createElement) {
    prevlen = window.frames.length;
    var ifmstatic = document.createElement('iframe'); 
    ifmstatic.setAttribute('name','idstatic');
    ifmstatic.setAttribute('id','idstatic');
    ifmstatic.setAttribute('src','bb_iframe1.html');
    ifmstatic.onload = function() {alert('passed 1 "iframe element onload with src"')};
    document.body.appendChild(ifmstatic);
    var winstatic = get_frame_window('2', 'idstatic', 'createElement with src', prevlen);
    //if (winstatic) winstatic.onload = function() {alert('passed 1+ "iframe window onload with src"')};
  }
  else {
    winstatic = window.frames['idh'];
    winempty = winstatic;
  }

  // create iframe with empty src attribute
  if (!bug_createElement) {
    prevlen = window.frames.length;
    var ifmempty = document.createElement('iframe');
    ifmempty.setAttribute('name','idempty'); 
    ifmempty.setAttribute('id','idempty'); 
    ifmempty.setAttribute('src','');
    ifmempty.onload = function() {alert('passed 3 "iframe element onload with no src"');};
    document.body.appendChild(ifmempty); 
    var winempty = get_frame_window('4', 'idempty', 'createElement with no src', prevlen);
    //if (winempty) winempty.onload = function() {alert('passed 3+ "iframe window onload with no src"')};
  }

  // test writing into iframe contents
  // Opera gives "Security Error: attempted to read protected variable" if document.write is done
  // when original src is ''.
  // On the other hand, Safari 73 crashes on an attempt to write to winstatic.
  //var winwrite = winempty;
  var winwrite = bug_emptySrc ? winstatic : winempty;
  //var winwrite = winstatic;
  if (winwrite) {
    alert("about to test document.write");
    //alert("about to write to document " + winwrite.document);
    winwrite.document.close();
    winwrite.document.open();
    //  + \' fallback:\' + document.body.fallback
    winwrite.document.write('<html><body onload="' +
            "alert('passed 5- dynamic iframe body onload. parent ' + (parent.test_iframe ? 'ok' : 'not ok'))" +
            '"><iframe id="inner" name="inner" src="bb_iframe4.html" onload="alert(\'passed Y\')"><\/iframe><\/body><\/html>'); 
    winwrite.document.close();
    alert("closed document");
    winwrite.document.body.onload = function() {alert('passed 5+ "override iframe body onload". test_iframe ' + (test_iframe ? 'ok' : 'not ok'))};
  }
  else alert("no window to test document.write with");

  // test changing the location
  alert("about to test location replace");
  var locreplace;
  var winreplace = winempty;
  var ifmreplace = ifmempty;
  if (winreplace) locreplace = winreplace.location;
  if (!locreplace && ifmreplace && ifmreplace.contentWindow) locreplace = ifmreplace.contentWindow.location;
  if (!locreplace && ifmreplace && ifmreplace.contentDocument) locreplace = ifmreplace.contentDocument.location;
  if (!locreplace && ifmreplace && ifmreplace.contentDocument && ifmreplace.contentDocument.defaultView) locreplace = ifmreplace.contentDocument.defaultView.location;
/*
  var locreplace = (winreplace && winreplace.location);
  if (!locreplace && ifmreplace) locreplace =
    (ifmreplace.contentWindow && ifmreplace.contentWindow.location) || 
    // Mozilla and W3
    (ifmreplace.contentDocument &&                                    
         (ifmreplace.contentDocument.location ||
          (ifmreplace.contentDocument.defaultView && ifmreplace.contentDocument.defaultView.location)));
*/
  if (locreplace) { 
    alert('passed 6 "dynamic iframe element location"');
    if (ifmreplace) ifmreplace.onload = function() {alert('passed 7 "iframe element onload after replace"')};
    locreplace.replace('bb_iframe2.html');
  }
  else {
    alert('failed "dynamic iframe element location"');
  }
}
</script>

For iframe support, the situation is complicated because the standards are not always clear,
and there are many issues. This test and table doesn't even cover all the things that affect
us (such as whether "display: none" disables an iframe).
<p>
For iframe-based data channel with an onload event independent of the particular url and its content,
a browser needs to have support for at least one of:
<ul>
<li>12,67 (createElement, with onload on iframe element and later replace). ideal, but only Mozilla and Opera 7.5 support it.
<li>ABC (innerHTML, with onload on iframe element). Works on IE6 and Mozilla and Opera 7.5.
<li>5 or Y (document.write with nested iframe). Works on IE6, IE5, Mozilla, Opera 7.x, Safari 1.0. (Will not work on Safari 73 despite passing "5-", because it can't find its parent.)
</ul> 
The above criteria still leave out Konqueror and ICE family browsers.
Note that KDE recently added support for W3 "Load and Save", which means that an iframe data channel is not as critical for Konqueror.
(See Peter Kelley, http://marc.theaimsgroup.com/?l=kfm-devel&amp;m=105618985421366&amp;w=2 ).
Also, Safari recently added XMLHttpRequest support.
<p>
To see the source of the test (what each of the letter codes for passes mean) do view source.
To run the test: <div style="border: 1px solid black" onclick="test_iframe()"><b>click here to run test_iframe()</b></div>
<p>

<table border="1">
<thead><tr><th>Family</th><th>Brand Version</th><th>Passes</th><th>Comment</th></tr></thead>
<tbody>
<!--
<tr><td>IE</td>      <td>6.0</td>             <td>BAC82465+XY9</td>       <td></td></tr>
-->
<tr><td>IE</td>      <td>6.0</td>             <td>BAC82945-XY69</td>     <td>Notice 9 twice. with slight changes to test, can get BAC82465+XY9</td></tr>
<tr><td>IE</td>      <td>5.0</td>             <td>BC5-X69</td>           <td></td></tr>
<tr><td>Mozilla</td> <td>Mozilla 1.4a</td>    <td>CBA28143XY5-3697</td>  <td>perfect except for 5+ vs. 5-</td></tr>
<tr><td>Opera</td>   <td>7.10</td>            <td>BC8245-X69</td>        <td>only B8 if no previous alert or setTimeout. security error if write to winempty.</td></tr>
<tr><td>Opera</td>   <td>7.5</td>             <td>CB284XY65+9A1717</td>  <td>note duplicate 1 and 7.</td></tr>

<tr><td>KHTML</td>   <td>Safari 1.0</td>      <td>C245-6B89</td>         <td>parent is bad in 5- for v73 but ok in 1.0. Both ok in test 8. crashes if write to winstatic.</td></tr>
<tr><td>KHTML</td>   <td>Safari 1.2</td>      <td>C245-6XY8197</td>      <td></td></tr>
<tr><td>KHTML</td>   <td>Konqueror 3.1.0</td> <td>CB28</td>              <td>only finds window.frames by index.</td></tr>
<tr><td>ICE</td>     <td>5.4</td>             <td>BC824X69</td>          <td>only B8 if no previous alert or setTimeout</td></tr>

</tbody>
</table>


</body></html>
