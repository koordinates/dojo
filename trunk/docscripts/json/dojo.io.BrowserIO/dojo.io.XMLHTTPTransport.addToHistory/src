var callback = args["back"]||args["backButton"]||args["handle"];
var hash = null;
if(!this.historyIframe){
	this.historyIframe = window.frames["djhistory"];
}
if(!this.bookmarkAnchor){
	this.bookmarkAnchor = document.createElement("a");
	(document.body||document.getElementsByTagName("body")[0]).appendChild(this.bookmarkAnchor);
	this.bookmarkAnchor.style.display = "none";
}
if((!args["changeUrl"])||(dojo.render.html.ie)){
	var url = dojo.hostenv.getBaseScriptUri()+"iframe_history.html?"+(new Date()).getTime();
	this.moveForward = true;
	dojo.io.setIFrameSrc(this.historyIframe, url, false);
}
if(args["changeUrl"]){
	hash = "#"+ ((args["changeUrl"]!==true) ? args["changeUrl"] : (new Date()).getTime());
	setTimeout("window.location.href = '"+hash+"';", 1);
	this.bookmarkAnchor.href = hash;
	if(dojo.render.html.ie){
		 IE requires manual setting of the hash since we are catching
		 events from the iframe
		var oldCB = callback;
		var lh = null;
		var hsl = this.historyStack.length-1;
		if(hsl>=0){
			while(!this.historyStack[hsl]["urlHash"]){
				hsl--;
			}
			lh = this.historyStack[hsl]["urlHash"];
		}
		if(lh){
			callback = function(){
				if(window.location.hash != ""){
					setTimeout("window.location.href = '"+lh+"';", 1);
				}
				oldCB();
			}
		}
		 when we issue a new bind(), we clobber the forward 
		 FIXME: is this always a good idea?
		this.forwardStack = []; 
		var oldFW = args["forward"]||args["forwardButton"];;
		var tfw = function(){
			if(window.location.hash != ""){
				window.location.href = hash;
			}
			if(oldFW){  we might not actually have one
				oldFW();
			}
		}
		if(args["forward"]){
			args.forward = tfw;
		}else if(args["forwardButton"]){
			args.forwardButton = tfw;
		}
	}else if(dojo.render.html.moz){
		 start the timer
		if(!this.locationTimer){
			this.locationTimer = setInterval("dojo.io.XMLHTTPTransport.checkLocation();", 200);
		}
	}
}

this.historyStack.push({"url": url, "callback": callback, "kwArgs": args, "urlHash": hash});